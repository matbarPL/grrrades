---
title: "Advanced Visualization in R"
subtitle: Using advanced visualization techniques to explore relationships between students' characteristics & performance.
author: "Wojciech Maślakiewicz & Mateusz Baryła"
output:
  html_document:
      df_print: paged
      toc: yes
      toc_float: yes
      collapsed: yes
      smooth_scroll: no
bibliography: bibliography.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, readxl, ggpubr, riverplot,
               gridExtra, grid, tidyverse, treemapify,
               ggradar, ggstance, ggthemes,ggcharts)
color_palette <- tibble(colors = c("#F5F5F5", "#F05454", "#30475E", "#121212"),
                        color_names = c("grey", "red", "blue", "black"))
```

# Introduction

Data was gathered using questionnaires and mark reports. Mark reports were provided
by schools and consist of grades and absences. Grades are evaluated in three periods
and marked in a 20-point grading scale where 0 is the lowest possible mark and
20 the highest. The former was used to gather the data for the several demographic,
social/emotional and school related variables. The final questionnaire containing
37 questions in a single A4 sheet was answered in class by 788 students. Later
111 answers were discarded due to lack of identification details. At the end the
data was merged into two samples that related to Mathematics (395) and
Portuguese (649) classes [@Cortez2008].

The merged dataset consist of 13 variables that uniquely identifies
each row and 20 that describe their performance at one of the subjects.
All the features can be split into categorical and numerical ones, but we
are rather interested in analyzing the variables rather than the right survey distribution [@Dua:2019].

```{r, echo = FALSE}
source("read_data.R")
source("plot_functions.R")
master_data <- read_data()
dictionary <- read_excel("dictionary.xlsx")
```

# Question 1
What kind of support students get for each subject?

```{r}

supp_m <- master_data %>% group_by(famsup_m,schoolsup_m,paid_m) %>%
  summarise(n = n(), grade = mean(G3_m), .groups = "rowwise") %>%
  mutate(cat_name = paste("f",famsup_m,"s",schoolsup_m,"p",paid_m,sep = '_')) %>%
  mutate(id = cur_group_id())

tmp_1 <- supp_m  %>% pivot_longer(c(famsup_m,schoolsup_m,paid_m))
## tiles
# calculate positions of tiles
max_n <- 1#max(supp_m$n)
tile_half_height <- (max_n*1.01)/6
tile_y_middles <- c(tile_half_height,3*tile_half_height,5*tile_half_height)

tiles_df <- data.frame(
  x = rep(seq(1,8,1), 3),
  y = rep(tile_y_middles, each = 8)
)%>% arrange(x) %>% mutate(z = tmp_1$value)

#maths
supp_plot_m <- ggplot() +
  geom_tile(data = tiles_df, aes(x, y,fill = z), colour = "white", alpha = 0.3)+
  scale_fill_manual(breaks=c("no","yes"),values=c("#f21a02","#a3d487"), name = "Support provided?")+
  scale_x_discrete()+
  geom_col(data = supp_m, aes(x=cat_name,y=n/sum(n)), alpha = 0.8, width = 0.8, fill = "steelblue")+
  scale_y_continuous(breaks = seq(0,1, length.out = 5)
                    ,sec.axis = sec_axis( ~.,
                                          breaks =c(tile_half_height,3*tile_half_height,5*tile_half_height),
                                          labels = c("Family support","School support", "Paid support")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.background = element_blank(),
        axis.line.y = element_line())+
  ylab("Fraction of students")+
  ggtitle("Maths")
```

```{r, echo = FALSE}
supp_plot_m
```

```{r}
# better varsion of barplot to answer the quesition PORT

# create additional variables

master_data %>% group_by(famsup_p,schoolsup_p,paid_p) %>%
  summarise(n = n(), grade = mean(G3_p)) %>%
  arrange(-grade) %>% pivot_longer(c(famsup_p,schoolsup_p,paid_p)) %>%
  mutate(bg_color = ifelse(value == "yes", "green","red")) ->tmp_1

supp_p <- master_data %>% group_by(famsup_p,schoolsup_p,paid_p) %>%
  summarise(n = n(), grade = mean(G3_p), .groups = "rowwise") %>%
  mutate(cat_name = paste("f",famsup_p,"s",schoolsup_p,"p",paid_p,sep = '_')) %>%
  mutate(id = cur_group_id())

tmp_1 <- supp_p  %>% pivot_longer(c(famsup_p,schoolsup_p,paid_p))
max_n <- max(supp_p$n)
tile_half_height <- (max_n+2)/6
tile_y_middles <- c(tile_half_height,3*tile_half_height,5*tile_half_height)

tiles_df <- data.frame(
  x = rep(seq(1,8,1), 3),
  y = rep(tile_y_middles, each = 8)
)%>% arrange(x) %>% mutate(z = tmp_1$value)


supp_plot_p <- ggplot() +
  geom_tile(data = tiles_df, aes(x, y,fill = z), colour = "white", alpha = 0.3)+
  scale_fill_manual(breaks=c("no","yes"),values=c("#f21a02","#a3d487"), name = "Support provided?")+
  scale_x_discrete()+
  geom_col(data = supp_p, aes(x=cat_name,y=n), alpha = 0.8, width = 0.8, fill = "steelblue")+
  scale_y_continuous(breaks = seq(10,max(supp_p$n), length.out = 5) %>% round()
                    ,sec.axis = sec_axis( ~.,
                                          breaks =c(tile_half_height,3*tile_half_height,5*tile_half_height),
                                          labels = c("Family support","School support", "Paid support")))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.background = element_blank(),
        axis.line.y = element_line())+
  ylab("Number of students")+
  ggtitle("Portuguese")


```
```{r}

supp_plot_m <- make_barplot_with_bg_tiles(master_data,famsup_m,schoolsup_m,paid_m,G3_m,
                                          title = '',
                                          bar_color = "#30475E")
supp_plot_p <- make_barplot_with_bg_tiles(master_data,famsup_p,schoolsup_p,paid_p,G3_p,
                                          title = '',
                                          bar_color = "#30475E")
# get rid of RIGHT axis in LEFT plot
supp_plot_p <- supp_plot_p + theme(axis.line.y.right = element_blank(),
                                   axis.text.y.right = element_blank(),
                                   axis.ticks.y.right = element_blank(),
                                   axis.title.y.right = element_blank(),
                                   axis.title.y.left = element_text(size=18),
                                   axis.text.y.left = element_text(size=19))

# get rid of LEFT axis in RIGHT plot
supp_plot_m <- supp_plot_m + theme(axis.line.y.left = element_blank(),
                                   axis.text.y.left = element_blank(),
                                   axis.ticks.y.left = element_blank(),
                                   axis.title.y.left = element_blank(),
                                   axis.title.y.right = element_text(size=18),
                                   axis.text.y.right = element_text(size=19))
comb <- ggarrange(supp_plot_p,supp_plot_m,
                  align = "h",
                  labels = c("Portuguese","Maths"),
                  font.label = list(size = 12, face = 'plain'),
                  hjust = c(-2,-2.5),
                  vjust = 3,
                  common.legend = T ,
                  legend = "bottom")

annotate_figure(comb , top = text_grob("Does obtaining support improve performance?",
                                       size = 27))
```

# Question 2
Do students improve their grades during the year?

```{r}
# attempt 1
# data
#<<<<<<< HEAD
grade_cuts <-  c(-1,7,13,21)
tmp1 <- master_data %>% 
  select(matches("G._m")) %>% 
  drop_na()%>% 
  mutate(across(everything(),
                ~cut(.x,breaks = grade_cuts,
                    labels = c("low","medium","high")))) %>% 
  group_by(G1_m,G2_m,G3_m) %>%
  summarise(n = n()) %>% 
  mutate(G1_m = paste0("First ",G1_m),
         G2_m = paste0("Second ",G2_m),
         G3_m = paste0("Final ",G3_m)) %>% 
  arrange(G1_m,G2_m)
# =======
# tmp1 <- master_data %>%
#   select(matches("G._m")) %>%
#   drop_na()%>%
#   mutate(across(everything(),
#                 ~cut(.x,breaks = c(-1,7,15,21),
#                     labels = c("low","medium","high")))) %>%
#   group_by(G1_m,G2_m) %>%
#   summarise(n = n()) %>%
#   mutate(G1_m = paste0("First ",G1_m),
#          G2_m = paste0("Second ",G2_m)) %>%
#   arrange(-n)
# >>>>>>> 7dc0b1bca1330e903b86366823e193324e68d2bb


# final plot
nodes <- data.frame(ID = unique(c(tmp1$G1_m,tmp1$G2_m,tmp1$G3_m) %>% sort()),
                    x = c(rep(3,3),rep(1,3),rep(2,3)),
                    y = rep(c(3,1,2),3))

tmp2 <- master_data %>% 
  select(matches("G._m")) %>% 
  drop_na()%>% 
  mutate(across(everything(),
                ~cut(.x,breaks =grade_cuts,
                    labels = c("low","medium","high")))) %>% 
  group_by(G1_m,G2_m) %>% 
  summarise(n = n()) %>% 
  mutate(G1_m = paste0("First ",G1_m),
         G2_m = paste0("Second ",G2_m)) %>% 
  rename(N1 = G1_m, N2 = G2_m, Value = n)

tmp3 <- master_data %>% 
  select(matches("G._m")) %>% 
  drop_na()%>% 
  mutate(across(everything(),
                ~cut(.x,breaks = grade_cuts,
                    labels = c("low","medium","high")))) %>% 
  group_by(G2_m,G3_m) %>% 
  summarise(n = n()) %>% 
  mutate(G2_m = paste0("Second ",G2_m),
         G3_m = paste0("Final ",G3_m)) %>% 
  rename(N1 = G2_m, N2 = G3_m, Value = n)

tmp4 <- rbind(tmp2,tmp3)

edges <- data.frame(ID = 1:nrow(tmp4),
                    N1 = tmp4$N1,
                    N2 = tmp4$N2,
                    Value = tmp4$Value)
cols <- c(low="#F05454",
medium="#30475E",
high ="#121212")
style <- sapply(nodes$ID, function(id)
list(col=cols[ gsub("(First|Second|Final) ", "", id) ]), simplify=FALSE)


# <<<<<<< HEAD
r <- makeRiver(nodes,edges,styles =style) 
d <- list(srt = 0, textcex=1, textcol = "white") 
# =======
# r <- makeRiver(nodes,edges,styles =style)
# d <- list(srt=0, textcex=1.5) # default style
# >>>>>>> 7dc0b1bca1330e903b86366823e193324e68d2bb
plot(r, plot_area=1, nodewidth=10, default_style=d)
title("Flows of students between performance groups")
```



# Question 3
What is the distribution of grades across subjects and periods in the current school year?

```{r}
grade_per_subject_long <-
  master_data %>%
  mutate(row_num = row_number()) %>%
  select(row_num, starts_with("G", ignore.case = FALSE)) %>%
  pivot_longer(-row_num) %>%
  separate(name, c("grade", "subject"))
subject_pretty_names <- tibble(short_name = c('m', 'p'),
                               pretty_name = c('Mathematics','Portugese'))
periods_colors <- tibble(period = 1:3,
                         color_name = color_palette$colors[2:4])

data_to_boxplot <- grade_per_subject_long %>%
  inner_join(subject_pretty_names, by = c("subject" = "short_name")) %>% separate(grade, 1, into = c("to_remove", "period")) %>%
  mutate(period = as.numeric(period)) %>%
  inner_join(periods_colors)
```

```{r}
grades_boxplot <- ggplot(data = data_to_boxplot,
       aes(y = value, x = factor(pretty_name),
           fill = factor(period),
           colour=factor(period))) +
  geom_boxplot(alpha = 0.6, show.legend = F) +
  geom_point(position = position_jitterdodge()) +
  ggtitle("What is the distribution of grades across \n subjects and periods in the current school year?") +
  labs(x = "Subject", y = "Grade", colour = "Period") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = periods_colors$color_name) +
  scale_fill_manual(values = periods_colors$color_name) +
  guides(fill=FALSE)
```


```{r}
grades_boxplot
```

Grades for Portugese were consistently higher than in Mathematics.
We do not observe neither a positive nor negative trend relating
to the subsequent periods results'.

# Question 4

How the amount of spare time and the way of spending it influence
the number of absences?


```{r}
grade_per_subject_long <-
  master_data %>%
  mutate(row_num = row_number()) %>%
  select(row_num, starts_with("G", ignore.case = FALSE)) %>%
  pivot_longer(-row_num) %>%
  separate(name, c("grade", "subject"))

absences.agg <- master_data %>%
  group_by(freetime_m, goout_m) %>%
  summarise(across(absences_m, ~n()))

low.high.map <- tibble(ugly_level = c(1, 2, 3, 4, 5),
                         pretty_level = c('very low',
                                               'low',
                                               'medium',
                                               'high',
                                               'very high'))

absences.agg.to.plot.m <- absences.agg %>%
  ungroup() %>%
  inner_join(low.high.map,
             by = c("freetime_m" = "ugly_level")) %>%
  rename( freetime_pretty = pretty_level) %>%
  inner_join(low.high.map,
             by = c("goout_m" = "ugly_level")) %>%
  rename( goout_pretty = pretty_level) %>% select(freetime_pretty, goout_pretty, absences_m)

absences.agg <- master_data %>%
  group_by(freetime_p, goout_p) %>%
  summarise(across(.cols = absences_p, .fns = ~sum(.)))

low.high.map <- tibble(ugly_level = c(1, 2, 3, 4, 5),
                       pretty_level = c('very low',
                                        'low',
                                        'medium',
                                        'high',
                                        'very high'))
absences.agg.to.plot.p <- absences.agg %>%
  ungroup() %>%
  inner_join(low.high.map,
             by = c("freetime_p" = "ugly_level")) %>%
  rename(freetime_pretty = pretty_level) %>%
  inner_join(low.high.map,
             by = c("goout_p" = "ugly_level")) %>%
  mutate(goout_p = factor(goout_p)) %>%
  rename( goout_pretty = pretty_level) %>%
  select(freetime_pretty, goout_pretty, absences_p)

absences.agg.to.plot.p$freetime_pretty <- factor(absences.agg.to.plot.p$freetime_pretty, levels = c("very low", "low", "medium", "high", "very high"))
absences.agg.to.plot.p$goout_pretty <- factor(absences.agg.to.plot.p$goout_pretty, levels = c("very low", "low", "medium", "high", "very high"))
```


```{r}
ggplot(absences.agg.to.plot.p, aes(x = freetime_pretty, y = goout_pretty)) +
  geom_tile(aes(fill = absences_p), color = 'white', show.legend = F) +
  theme_minimal() +
  geom_text(aes(label = absences_p), size = 5, fontface = 'bold', color = 'white') +
  labs(title ='How the amount of spare time and going out with friends \n influence the number of absences at Portugese classes?',
       x = "Free time after school",
       y = "Going out with friends") +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 15),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15)) +
    scale_fill_gradient(low = color_palette$colors[3],
                        high = color_palette$colors[2])
```

# Question 5
Does relationship status influence a number of absences?

```{r}
tmp1 <-   master_data %>%
  group_by(Medu,Fedu,Pstatus) %>%
  summarise(avg_grade_m = mean(G3_m) %>% round(2),
            avg_grade_p = mean(G3_p) %>% round(2)
            ) %>%
  mutate(grades = paste("M:",avg_grade_m,"\nP:",avg_grade_p))

master_data %>%
ggplot()+
  geom_bin2d(aes(as.factor(Medu),as.factor(Fedu), fill = ..count../nrow(master_data)))+
  labs(x = "mother's education",
       y = "father's education",
       fill = "fraction of students",
       title = "Average grades of students given their parents education")+
  scale_x_discrete(labels = c('none',
                              '4th grade',
                              '5th to 9th grade',
                              'secondary education',
                              ' higher education' ))+
    scale_y_discrete(labels = c('none',
                              '4th grade',
                              '5th to 9th grade',
                              'secondary education',
                              ' higher education' ))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.6, hjust=0.5)) +
  geom_text(data = tmp1,aes(as.factor(Medu),as.factor(Fedu),label =grades),
            color = "white",
            size = 3)+
  scale_fill_gradient(low = color_palette$colors[3],
                      high = color_palette$colors[2])+
  facet_wrap(.~Pstatus,ncol=1 ,labeller = as_labeller(c("A" = "parents live apart","T" = "parents live together")))
```

# Question 6

Is there any association between students' performance across periods and subjects?

```{r}
pass_fail_association <- master_data %>%
  mutate(current_failure_m = if_else(G3_m >= 10, 1, 0),
         current_failure_p = if_else(G3_p >= 10, 1, 0),
         failures_m_general = if_else(failures_m > 0, 1, 0),
         failures_p_general = if_else(failures_p > 0, 1, 0)) %>%
  group_by(failures_m_general, current_failure_m, failures_p_general, current_failure_p) %>% count()
pass_fail_association$group <- c("Rockstars",
                                 "Accidents \n will happen",
                                 "Accidents \n will happen",
                                 "Achilles' heel",
                                 "Achilles' heel",
                                 "Accidents \n will happen",
                                 "Accepting \n trade-off",
                                 "Rockstars",
                                 "Misery loves \n company",
                                 "Achilles' heel",
                                 "Achilles' heel",
                                 "Misery loves \n company",
                                 "Misery loves \n company")
pass_fail_association_aggregate <- pass_fail_association %>%
  group_by(group) %>%
  summarise(student_count = sum(n))
```

We created five groups that describe the consistency of the students' performance across periods.

- Accidents will happen describe a group of people that generally pass both Mathematics and Portugese subjects but have experiences at least one failure.

- With the Achilles' heel we associate guys that consequently have problem with passing either Mathematics or Portugese.

- The Rockstars have been depicted as the students that either are the gifted ones and pass both subjects consequently or after failing both previously now passed them.

- With the mistery loves company description we try to motivate the folks that have issues with learning at school and consequently experience problems at school.

- Accepting trade-off relate to the students that sacrifice one subject for the sake of the other.

```{r}
ggplot(pass_fail_association_aggregate,
       aes(area = student_count,
           label = group,
       fill = student_count)) +
  geom_treemap() +
  geom_treemap_text(fontface = "italic", colour = "white", place = "centre") +
  labs(title = "What groups students form across school years?",
       fill = "Students \n count") +
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.title = element_text(hjust = 0.5, size = 15),
        axis.text = element_text(size = 15)) +
  scale_fill_gradient(low = color_palette$colors[3],
                      high = color_palette$colors[2])
```

# Question 7

What is the distribution of absences in each of the aforementioned groups?
```{r}
groups_mean_absences <- master_data %>%
  mutate(current_failure_m = if_else(G3_m >= 10, 1, 0),
         current_failure_p = if_else(G3_p >= 10, 1, 0),
         failures_m_general = if_else(failures_m > 0, 1, 0),
         failures_p_general = if_else(failures_p > 0, 1, 0)) %>%
  mutate(mean_absences = (absences_m + absences_p)/2) %>%
  group_by(failures_m_general, current_failure_m, failures_p_general, current_failure_p) %>% summarise(across(mean_absences, ~mean(.)))

groups_mean_absences$group <- c("Rockstars",
                                 "Accidents will happen",
                                 "Accidents will happen",
                                 "Achilles' heel",
                                 "Achilles' heel",
                                 "Accidents will happen",
                                 "Accepting trade-off",
                                 "Rockstars",
                                 "Misery loves company",
                                 "Achilles' heel",
                                 "Achilles' heel",
                                 "Misery loves company",
                                 "Misery loves company")
```
```{r}
groups_mean_absences %>%
  group_by(group) %>%
  summarise(across(mean_absences, list(median = ~median(.)))) %>%
  ggdotchart(x = "group", y = "mean_absences_median",
             ylab = "Median of mean absences in each group",
             title = "What is the distribution of absences in the created groups?",
           palette = c("#00AFBB", "#E7B800", "#FC4E07"),
           font.label = list(size = 14, face = "plain"),
           sorting = "descending",
           rotate = TRUE,
           dot.size = 2,
           y.text.col = TRUE) +
  theme_cleveland() +
  theme(plot.title = element_text(size = 15))
```

# Question 8

What is the impact of students' lifestyle for their performance?

```{r}
all_numeric_var <- dictionary %>% filter(type == 'numeric') %>% pull(variable)
dims <- paste0(all_numeric_var[4:11], "_m")
dims <- append(dims, "G3_m")
final_dims <- c("Dalc_m", "Walc_m", "studytime_m", "absences_m", "G3_m")
master_data_to_radar_m <- master_data %>%
    mutate(across(final_dims, scales::rescale)) %>%
    group_by(higher_m) %>%
    summarise(across(all_of(final_dims), ~mean(.)))
names(master_data_to_radar_m) <- c("Wants to take \n higher education",
                                   "Workday alcohol \n consumption",
                                   "Weekend \n alcohol \n consumption",
                                   "Weekly \n study time",
                                   "Number of \n school absences",
                                   "Mathematics \n final grade")
```
```{r, dpi = 100}
ggradar(master_data_to_radar_m,
        plot.title = "What is the impact of students' lifestyle?",
        legend.title = "Wants to \n take higher \n education",
        axis.label.size = 3,
        legend.text.size = 10,
        gridline.mid.colour = color_palette$colors[4],
        group.colours = color_palette$colors[c(2,3)]) +
  theme(legend.title=element_text(size=10), plot.title = element_text(size = 15))
```

# Question 9

Are there gender differences in grades?

```{r}
# calculate percentages
helper_df <- master_data %>%
  # mutate(fake_id = 1) %>%
  # group_by(fake_id) %>%
  summarise(mop = sum(G3_m>G3_p),
            pom = sum(G3_m<G3_p),
            fmop = sum((G3_m>G3_p) & sex == 'F'),
            fpom = sum((G3_m<G3_p) & sex == 'F')) %>%
  mutate(fmop_perc = fmop/mop, mmop_perc = 1-fmop_perc,
         fpom_perc = fpom/pom, mpom_perc = 1-fpom_perc,
         mop_perc = mop/nrow(master_data),
         pom_perc = pom/nrow(master_data))

helper_df_2 <- helper_df %>%
  pivot_longer(c(mmop_perc,fmop_perc,mpom_perc,fpom_perc)) %>%
  select(c(name,value)) %>%
  .[1:2,]

helper_df_3 <- helper_df %>%
  pivot_longer(c(mmop_perc,fmop_perc,mpom_perc,fpom_perc)) %>%
  select(c(name,value)) %>%
  .[3:4,]

# <<<<<<< HEAD
 seg_end_lst <- get_diag_segment_ends(side_length = 22)
 seg_end <- seg_end_lst$end
 fem_perc_diag <- seg_end_lst$fem_perc
                                                  
plt <-   
# =======
master_data %>%
  #pivot_longer(c(G3_m,G3_p)) %>%
# >>>>>>> 7dc0b1bca1330e903b86366823e193324e68d2bb
  ggplot()+
  geom_segment(aes(x=0,y=0,xend=seg_end,yend=seg_end), size = 6, color ="#F05454", alpha = 0.5 )+
  geom_segment(aes(x=seg_end,y=seg_end,xend=20,yend=20), size = 6, color ="#30475E",alpha = 0.5 )+
  geom_point(data = master_data,aes(x=G3_m,y=G3_p,color = sex),
             size = 3,
             position=position_dodge(width=0.5),
             alpha = 1)+
  #geom_abline(slope = 1,intercept = 0)+
  annotate("text",label = paste("Better portuguese \nthan maths:\n",
                                round(helper_df$pom_perc*100),
                                "% of all"),
            size = 4 ,
           fontface = "italic",
           x =4.5, y =17)+
  annotate("text",
           label = paste("Better maths \nthan portuguese:\n",
                        round(helper_df$mop_perc*100),
                        "% of all"),
           size = 4 ,
           fontface = "italic",
           x =17, y =3) +
  annotate("text",
           label = paste0(round(fem_perc_diag*100),"%"),
           size = 4,
           color ="White",
           x =1, y =1,
           angle = 45)+
    annotate("text",
           label = paste0(round((1-fem_perc_diag)*100),"%"),
           size = 4,
           color ="White",
           x =19, y =19,
           angle = 45)+
  #scale_fill_manual(values = c("#F05454", "#F05454","#30475E", "#30475E"),)+
  guides(fill="none")+
  scale_color_manual(values = c("#F05454","#30475E"),labels = c("female","male"))+
  coord_fixed()+
  #coord_cartesian(xlim = c(0,20),ylim = c(0,20))+
  labs(x="Maths grade", y="Portuguese grade", title = "Relationship between grades from two subjects by gender")+
  theme(panel.grid = element_blank(),
        legend.box.background = element_blank(),
        legend.key = element_rect(colour = "transparent",fill = alpha("red", 0)),
        plot.margin = margin(0,0,0,-20)
        )#panel.background = element_blank()) #element_rect(fill = "#F5F5F5", size = 5))
 
  #pivot_longer(c(G3_m,G3_p)) %>% 
  plt_b <- ggplot(data = helper_df_2)+
  geom_colh(aes(y = 0,x = value,fill = name),
            position = "stackv",
            width = 0.5)+
  scale_fill_manual(values = c("#F05454", "#30475E"),
                    labels = c("female","male")) + 
  theme_void()+
  theme(legend.position = "none")+
  geom_text(aes(x = (1-value)+0.1, y = 0,label = paste0(round(value,2)*100,"%")),
            color = "white")
  
  plt_l <- ggplot(data = helper_df_3)+
  geom_col(aes(x = 0,y = value,fill = name),
           position = "stack",
            width = 0.5)+
  scale_fill_manual(values = c("#F05454", "#30475E"),
                    labels = c("female","male")) + 
  theme_void()+
  theme(legend.position = "none")+
  geom_text(aes(x =0 , y = value - 0.1,label = paste0(round(value,2)*100,"%")),
            color = "white")
  
  
  
   
   
  lay <- rbind(c(1,2,2,2),
               c(NA,NA,NA,NA),
               c(NA,NA,3,NA))
    
  plt_fin <- arrangeGrob(plt_l,plt,plt_b, 
              layout_matrix = lay,
              widths = c(3,1,20,5),
              heights = c(25,1,2))
  #margin = theme(plot.margin = margin(0,0,0,0))

  grid.arrange(plt_fin)
 
```


```{r}
# <<<<<<< HEAD
math_pyr <- master_data %>% 
  group_by(age,sex) %>% 
  summarise(grade_m = mean(G3_m), grade_p = mean(G3_p), n = n()) %>% 
  filter(age<=19) %>% 
  mutate(sex = ifelse(sex == "F","Female","Male")) %>% 
  #pivot_longer(-c(age,sex)) %>% 
  
pyramid_chart( x = age, y = grade_m, group = sex,
               xlab = "Maths average grade",
               bar_colors = c("#F05454","#30475E"))
  
  

port_pyr <- master_data %>% 
  group_by(age,sex) %>% 
  summarise(grade_m = mean(G3_m), grade_p = mean(G3_p), n = n()) %>% 
  #pivot_longer(-c(age,sex)) %>% 
    filter(age<=19) %>%  
  mutate(sex = ifelse(sex == "F","Female","Male")) %>% 
# =======
# master_data %>%
#   group_by(age,sex) %>%
#   summarise(grade_m = mean(G3_m), grade_p = mean(G3_p), n = n()) %>%
#   filter(age<=19) %>%
#   #pivot_longer(-c(age,sex)) %>%
# 
# pyramid_chart( x = age, y = grade_m, group = sex,
#                xlab = "grade", title = "Maths grade by age and gender")
# 
# 
# 
# master_data %>%
#   group_by(age,sex) %>%
#   summarise(grade_m = mean(G3_m), grade_p = mean(G3_p), n = n()) %>%
#   #pivot_longer(-c(age,sex)) %>%
#     filter(age<=19) %>%
# >>>>>>> 7dc0b1bca1330e903b86366823e193324e68d2bb
pyramid_chart( x = age, y = grade_p, group = sex,
               xlab = "Portuguese average grade",
               bar_colors = c("#F05454","#30475E"))


# <<<<<<< HEAD
comb <- ggarrange(math_pyr,port_pyr)
annotate_figure(comb,top = text_grob("Grade average by age and gender",
                                       size = 20))
# =======
# 
# >>>>>>> 7dc0b1bca1330e903b86366823e193324e68d2bb
```

# References
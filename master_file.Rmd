---
title: "AVR"
output:
  html_document:
      df_print: paged
      toc: yes
      toc_float: yes
      collapsed: yes
      smooth_scroll: no
bibliography: bibliography.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, readxl)
options(device = "windows")
```

# Introduction

Data was gathered using questionnaires and mark reports. Mark reports were provided
by schools and consist of grades and absences. Grades are evaluated in three periods
and marked in a 20-point grading scale where 0 is the lowest possible mark and
20 the highest. The former was used to gather the data for the several demographic,
social/emotional and school related variables. The final questionnaire containing
37 questions in a single A4 sheet was answered in class by 788 students. Later
111 answers were discarded due to lack of identification details. At the end the
data was merged into two samples that related to Mathematics (395) and
Portuguese (649) classes.

The merged dataset consist of 13 variables that uniquely identifies
each row and 20 that describe their performance at one of the subjects. 
All the features can be split into categorical and numerical ones, but we 
are rather interested in analyzing the variables rather than the right survey distribution.

```{r}
index <- c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet")
index
```



```{r}
source("read_data.R")
master_data <- read_data()
dictionary <- read_excel("dictionary.xlsx")
```

Let's plot the dependency between grades in Math and Portugese subjects.

```{r}
ggplot(master_data, aes(G1_m, G1_p)) +
  geom_point(aes(size = freetime_m)) +
  geom_smooth() +
  labs(x = "Grade in Mathematics",
       y = "Grade in Portugese",
       title = "Relationship between results in the first period")
```
Smaller points in the plot show that students with very little freetime haven't managed to keep excellent results in both subjects and they need to prioritize. 
# Question 1
Getting into the weeds of studentâ€™s health among two schools might reveal their well-being.

When analyzing the dataset it confused us that there are two separate columns for health.
We were convinced that this should be gathered only once during the research. The decision was made to check how attending the particular subject influences the responses.

```{r}
health_eq_acc_points <- master_data %>%
        mutate(health_eq = if_else(health_m == health_p, 1, 0)) %>%
        group_by(health_m, health_p) %>%
        summarise(cnt = n())
```


```{r}
ggplot(master_data %>%
               inner_join(health_eq_acc_points),
       aes(x = health_m, y = health_p, size = cnt)) +
        scale_size(name   = "",
                   breaks = c(144, 61, 1),
                   labels = c('144', '[42, 80]', '[1, 2]')) +
        geom_point() +
        labs(y = 'Health reported in the math classes',
             x = 'Health reported in the portugese classes',
             title = 'Relationship between reported health at Math and Portguese classess')
```

Most students reported the same health condition in Math and Portugese classes.

```{r}
grade_per_subject_long <-
  master_data %>%
  mutate(row_num = row_number()) %>%
  select(row_num, starts_with("G", ignore.case = FALSE)) %>%
  pivot_longer(-row_num) %>%
  separate(name, c("grade", "subject"))
```

```{r}
subject_pretty_names <- tibble(short_name = c('m', 'p'),
                               pretty_name = c('Mathematics','Portugese'))
```
```{r}
grade_per_subject_long %>%
  inner_join(subject_pretty_names, by = c("subject" = 'short_name')) %>%
  ggplot(aes(x = value)) +
  geom_density() +
  facet_grid(grade~pretty_name)
```

Grades for Portugese were consistently higher than in Mathematics.
We do not observe neither a positive nor negative trend relating
to the subsequent periods results'.


```{r}
absences.agg <- master_data %>%
  group_by(freetime_m, goout_m) %>%
  summarise(across(absences_m, ~n()))

low.high.map <- tibble(ugly_level = c(1, 2, 3, 4, 5),
                         pretty_level = c('very low',
                                               'low',
                                               'medium',
                                               'high',
                                               'very high'))

absences.agg.to.plot.m <- absences.agg %>%
  ungroup() %>%
  inner_join(low.high.map,
             by = c("freetime_m" = "ugly_level")) %>%
  rename( freetime_pretty = pretty_level) %>%
  inner_join(low.high.map,
             by = c("goout_m" = "ugly_level")) %>%
  rename( goout_pretty = pretty_level) %>% select(freetime_pretty, goout_pretty, absences_m)
# Best way to present two way distribution is heatmap. In R we can achieve it with
# geom_tile()
absences.m.plot <-
  ggplot(absences.agg.to.plot.m, aes(x = freetime_pretty, y = goout_pretty)) + # nowa baza danych
  geom_tile(aes(fill = absences_m), color = 'white', show.legend = F) +
  theme_minimal() +
  geom_text(aes(label = absences_m), size = 5, fontface = 'bold', color = 'white') +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank()) + ggtitle('Mathematics')
```
```{r}
absences.agg <- master_data %>%
  group_by(freetime_p, goout_p) %>%
  summarise(across(absences_p, ~n()))

low.high.map <- tibble(ugly_level = c(1, 2, 3, 4, 5),
                       pretty_level = c('very low',
                                        'low',
                                        'medium',
                                        'high',
                                        'very high'))

absences.agg.to.plot.p <- absences.agg %>%
  ungroup() %>%
  inner_join(low.high.map,
             by = c("freetime_p" = "ugly_level")) %>%
  rename( freetime_pretty = pretty_level) %>%
  inner_join(low.high.map,
             by = c("goout_p" = "ugly_level")) %>%
  rename( goout_pretty = pretty_level) %>% select(freetime_pretty, goout_pretty, absences_p)
# Best way to present two way distribution is heatmap. In R we can achieve it with
# geom_tile()

absences.p.plot <-
ggplot(absences.agg.to.plot.p, aes(x = freetime_pretty, y = goout_pretty)) + # nowa baza danych
  geom_tile(aes(fill = absences_p), color = 'white', show.legend = F) +
  theme_minimal() +
  geom_text(aes(label = absences_p), size = 5, fontface = 'bold', color = 'white') +
  theme(panel.grid = element_blank(),
axis.title.x = element_blank(),
        axis.title.y = element_blank()) + ggtitle('Portugese')
```

```{r}
grid.arrange(arrangeGrob(absences.m.plot + theme(legend.position = "none"),
                         absences.p.plot + theme(legend.position = "none"),
                         ncol = 2),
             nrow = 2,
             heights = c(10, 1), # relative height of two rows
             top = textGrob("Consideration of the spare time might be an indicator for the number of absences.", vjust = 1, gp = gpar(fontface = "bold", cex = 1.5)),
             left = textGrob("Free time after school", rot = 90, vjust = 1),
             bottom = textGrob("Going out with friends", rot = 0, vjust = -2)
)

```
# References
